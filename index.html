<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SocietyGuard â€” Security Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
  <script src="https://unpkg.com/recharts@2.5.0/umd/Recharts.js"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:#0a0c10;font-family:'Segoe UI',sans-serif;color:#e2e8f0}

    /* â”€â”€ CSS VARIABLES FOR THEMING â”€â”€ */
    :root {
      --bg:        #0a0c10;
      --bg2:       #0f1923;
      --bg3:       rgba(15,23,36,0.9);
      --border:    rgba(56,189,248,0.12);
      --border2:   rgba(51,65,85,0.5);
      --text:      #e2e8f0;
      --text2:     #94a3b8;
      --text3:     #64748b;
      --card-bg:   rgba(15,23,36,0.9);
      --input-bg:  rgba(30,41,59,0.8);
      --input-border: rgba(51,65,85,0.8);
      --nav-bg:    rgba(10,12,16,0.98);
      --webhook-bg:rgba(10,12,16,0.95);
      --row-border:rgba(51,65,85,0.3);
      --login-bg:  linear-gradient(135deg,#0a0c10,#0d1117,#0f1923);
      --login-card-bg: rgba(15,23,36,0.95);
      --login-card-border: rgba(56,189,248,0.2);
      --login-card-shadow: 0 0 60px rgba(56,189,248,0.08),0 40px 80px rgba(0,0,0,0.6);
      --table-th:  #64748b;
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg:        #f1f5f9;
        --bg2:       #e2e8f0;
        --bg3:       #ffffff;
        --border:    rgba(0,0,0,0.08);
        --border2:   rgba(0,0,0,0.1);
        --text:      #0f172a;
        --text2:     #334155;
        --text3:     #64748b;
        --card-bg:   #ffffff;
        --input-bg:  #f8fafc;
        --input-border: #cbd5e1;
        --nav-bg:    rgba(255,255,255,0.98);
        --webhook-bg:#f8fafc;
        --row-border:rgba(0,0,0,0.06);
        --login-bg:  linear-gradient(135deg,#e2e8f0,#f1f5f9,#ffffff);
        --login-card-bg: #ffffff;
        --login-card-border: rgba(0,0,0,0.1);
        --login-card-shadow: 0 20px 60px rgba(0,0,0,0.08),0 40px 80px rgba(0,0,0,0.1);
        --table-th:  #475569;
      }
    }
    body { background: var(--bg) !important; color: var(--text) !important; }
    .sg-nav-el   { background: var(--nav-bg) !important; border-bottom: 1px solid var(--border) !important; }
    .sg-card-el  { background: var(--card-bg) !important; border-color: var(--border) !important; color: var(--text) !important; }
    .sg-input-el { background: var(--input-bg) !important; border-color: var(--input-border) !important; color: var(--text) !important; }
    .sg-login-bg { background: var(--login-bg) !important; }
    .sg-login-card-el { background: var(--login-card-bg) !important; border-color: var(--login-card-border) !important; box-shadow: var(--login-card-shadow) !important; }
    .sg-td-el    { color: var(--text2) !important; border-color: var(--row-border) !important; }
    .sg-th-el    { color: var(--table-th) !important; border-color: var(--border2) !important; }
    .sg-webhook-el { background: var(--webhook-bg) !important; border-color: var(--border) !important; }
    .sg-label-el { color: var(--text3) !important; }
    ::-webkit-scrollbar{width:6px;height:6px}
    ::-webkit-scrollbar-track{background:#0a0c10}
    ::-webkit-scrollbar-thumb{background:#1e293b;border-radius:3px}
    select option{background:#0f1923}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* â”€â”€ MOBILE RESPONSIVE â”€â”€ */
    @media (max-width: 768px) {
      /* Nav */
      .sg-nav { flex-wrap: wrap; height: auto !important; padding: 12px 16px !important; gap: 10px; }
      .sg-nav-left { flex-wrap: wrap; gap: 8px; }
      .sg-nav-right { flex-wrap: wrap; gap: 8px; width: 100%; justify-content: space-between; }

      /* Main padding */
      .sg-main { padding: 16px !important; }

      /* Stats grid - 2 cols on mobile */
      .sg-stats-grid { grid-template-columns: repeat(2, 1fr) !important; gap: 10px !important; }

      /* Charts - single col on mobile */
      .sg-chart-grid { grid-template-columns: 1fr !important; }

      /* Login card */
      .sg-login-card { width: 90vw !important; padding: 32px 24px !important; }

      /* Tables - horizontal scroll */
      .sg-table-wrap { overflow-x: auto !important; }
      .sg-table-wrap table { min-width: 500px; }

      /* Webhook panel */
      .sg-webhook-url { flex-direction: column !important; gap: 8px; align-items: flex-start !important; }

      /* Chart header wrap */
      .sg-chart-header { flex-direction: column !important; align-items: flex-start !important; }

      /* Hide thumbnail on very small screens */
      .sg-thumb-cell { display: none; }
      .sg-thumb-header { display: none; }
    }

    @media (max-width: 480px) {
      .sg-stats-grid { grid-template-columns: 1fr !important; }
      .sg-brand-text { font-size: 14px !important; }
    }
  </style>
</head>
<body>
<div id="root"><div style="display:flex;align-items:center;justify-content:center;height:100vh;color:#38bdf8;font-size:14px">Loading SocietyGuard...</div></div>
<script>
// â”€â”€ CONFIG â”€â”€
const BACKEND_URL = "https://societyguard-backend.onrender.com";
const API_KEY = "sg-mysociety-2026";

const CLIENTS = [
  {id:"C01",name:"Green Valley Society"},
  {id:"C02",name:"Sunrise Heights"},
  {id:"C03",name:"Royal Palms"},
];
// Users authenticated via backend API
const COLORS=["#38bdf8","#818cf8","#34d399","#fb923c","#f472b6","#a78bfa"];

// Camera names loaded from DB via /api/cameras
let _cameraNames = {};
async function loadCameraNames(){
  try{ const r=await apiFetch("/api/cameras"); r.forEach(c=>{_cameraNames[c.camera_uid]=c.name;}); }catch(e){}
}
function getCameraName(id){ return _cameraNames[String(id)] || "Camera "+id; }

async function apiFetch(path, opts={}){
  const uid = window._sgUserId||"";
  const r=await fetch(BACKEND_URL+path,{
    ...opts,
    headers:{"x-api-key":API_KEY,"Content-Type":"application/json","x-user-id":uid,...(opts.headers||{})}
  });
  if(!r.ok){const e=await r.json().catch(()=>({}));throw new Error(e.error||r.status);}
  return r.json();
}

// â”€â”€ Wait for Recharts to load then boot app â”€â”€
function waitAndBoot(tries){
  if(tries>20){document.getElementById("root").innerHTML='<div style="color:#f87171;padding:40px;text-align:center">Failed to load chart libraries. Please refresh the page.</div>';return;}
  if(typeof Recharts==="undefined"){setTimeout(()=>waitAndBoot(tries+1),300);return;}
  bootApp();
}

function bootApp(){
  const {useState,useEffect,useCallback,useRef}=React;
  const {BarChart,Bar,PieChart,Pie,Cell,XAxis,YAxis,CartesianGrid,Tooltip,Legend,ResponsiveContainer}=Recharts;

  const tt={contentStyle:{background:"#0f1923",border:"1px solid #1e293b",borderRadius:8,color:"#e2e8f0"}};

  function el(type,props,...children){return React.createElement(type,props,...children);}

  // â”€â”€ STAT CARD â”€â”€
  function StatCard({label,value,delta,pos,accent,icon}){
    accent=accent||"#38bdf8";
    return el("div",{style:{background:"rgba(15,23,36,0.9)",border:`1px solid ${accent}22`,borderRadius:12,padding:"20px 24px",position:"relative",overflow:"hidden"}},
      el("div",{style:{position:"absolute",top:0,right:0,width:80,height:80,background:`radial-gradient(circle,${accent}15 0%,transparent 70%)`,borderRadius:"50%"}}),
      el("div",{style:{display:"flex",justifyContent:"space-between"}},
        el("div",null,
          el("div",{style:{fontSize:11,color:"#64748b",fontWeight:600,letterSpacing:1,textTransform:"uppercase",marginBottom:8}},label),
          el("div",{style:{fontSize:32,fontWeight:800,color:accent,lineHeight:1,marginBottom:4}},value!=null?value:"â€”"),
          delta&&el("div",{style:{fontSize:12,color:pos?"#4ade80":"#f87171",fontWeight:600}},(pos?"â–²":"â–¼")+" "+delta)
        ),
        el("div",{style:{fontSize:24,opacity:0.4}},icon)
      )
    );
  }

  // â”€â”€ LOGIN â”€â”€
  function LoginPage({onLogin}){
    const [u,setU]=useState(""); const [p,setP]=useState(""); const [err,setErr]=useState("");
    const [loading,setLoading]=useState(false);
    const login=async()=>{
      if(!u||!p){setErr("Please enter username and password.");return;}
      setLoading(true);setErr("");
      try{
        const r=await fetch(BACKEND_URL+"/api/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:u,password:p})});
        const data=await r.json();
        if(!r.ok){setErr(data.error||"Invalid credentials.");return;}
        window._sgUserId=data.id; onLogin(data);
      }catch(e){setErr("Cannot reach server. Please try again.");}
      finally{setLoading(false);}
    };
    return el("div",{className:"sg-login-bg",style:{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",background:"linear-gradient(135deg,#0a0c10,#0d1117,#0f1923)",position:"relative",overflow:"hidden"}},
      el("div",{style:{position:"absolute",inset:0,backgroundImage:"url('https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=1200&q=80')",backgroundSize:"cover",backgroundPosition:"center",filter:"brightness(0.15)"}}),
      el("div",{style:{position:"absolute",inset:0,backgroundImage:"linear-gradient(rgba(56,189,248,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(56,189,248,0.03) 1px,transparent 1px)",backgroundSize:"40px 40px"}}),
      el("div",{className:"sg-login-card sg-login-card-el",style:{background:"rgba(15,23,36,0.95)",border:"1px solid rgba(56,189,248,0.2)",borderRadius:16,padding:"48px 40px",width:400,boxShadow:"0 0 60px rgba(56,189,248,0.08),0 40px 80px rgba(0,0,0,0.6)",position:"relative",zIndex:1}},
        el("div",{style:{display:"flex",alignItems:"center",gap:10,marginBottom:32}},
          el("div",{style:{width:40,height:40,background:"linear-gradient(135deg,#38bdf8,#0ea5e9)",borderRadius:10,display:"flex",alignItems:"center",justifyContent:"center",fontSize:20}},"ðŸ¢"),
          el("div",null,
            el("div",{style:{fontSize:20,fontWeight:700,color:"#f1f5f9",letterSpacing:-0.5}},"SocietyGuard"),
            el("div",{style:{fontSize:11,color:"#64748b",letterSpacing:2,textTransform:"uppercase"}},"Security Intelligence Platform")
          )
        ),
        el("div",{style:{marginBottom:20}},
          el("label",{style:{fontSize:12,color:"#64748b",fontWeight:600,letterSpacing:1,textTransform:"uppercase",marginBottom:6,display:"block"}},"Username"),
          el("input",{className:"sg-input-el",style:{width:"100%",padding:"12px 14px",background:"rgba(30,41,59,0.8)",border:"1px solid rgba(51,65,85,0.8)",borderRadius:8,color:"#e2e8f0",fontSize:14,outline:"none"},value:u,onChange:e=>setU(e.target.value),onKeyDown:e=>e.key==="Enter"&&login(),placeholder:"Enter username"})
        ),
        el("div",{style:{marginBottom:24}},
          el("label",{style:{fontSize:12,color:"#64748b",fontWeight:600,letterSpacing:1,textTransform:"uppercase",marginBottom:6,display:"block"}},"Password"),
          el("input",{className:"sg-input-el",style:{width:"100%",padding:"12px 14px",background:"rgba(30,41,59,0.8)",border:"1px solid rgba(51,65,85,0.8)",borderRadius:8,color:"#e2e8f0",fontSize:14,outline:"none"},type:"password",value:p,onChange:e=>setP(e.target.value),onKeyDown:e=>e.key==="Enter"&&login(),placeholder:"Enter password"})
        ),
        el("button",{style:{width:"100%",padding:13,background:"linear-gradient(135deg,#0ea5e9,#38bdf8)",border:"none",borderRadius:8,color:"#0a0c10",fontSize:14,fontWeight:700,cursor:"pointer",marginTop:8,opacity:loading?0.7:1},onClick:login,disabled:loading},loading?"Signing in...":"Sign In â†’"),
        err&&el("div",{style:{color:"#f87171",fontSize:12,marginTop:8,textAlign:"center"}},err),
        el("div",{style:{marginTop:24,padding:12,background:"rgba(30,41,59,0.5)",borderRadius:8,fontSize:11,color:"#475569"}},
          el("div",{style:{fontWeight:700,marginBottom:4,color:"#64748b"}},"LOGIN CREDENTIALS"),
          el("div",null,"superadmin / Super@Guard2026!"),
          el("div",null,"secretary / GreenValley@2026!"),
          el("div",null,"guard1 / Guard@Secure26!")
        )
      )
    );
  }

  // â”€â”€ DASHBOARD â”€â”€
  function Dashboard({user,onLogout}){
    const [client,setClient]=useState(user.client||"C01");
    const [stats,setStats]=useState(null);
    const [events,setEvents]=useState([]);
    const [loading,setLoading]=useState(true);
    const [ok,setOk]=useState(null);
    const [vf,setVf]=useState("today");
    const [vc,setVc]=useState("Bar");
    const [cc,setCc]=useState("Bar");
    const [dc,setDc]=useState("Bar");
    const [log,setLog]=useState([]);
    const [copied,setCopied]=useState(false);
    const [activeTab,setActiveTab]=useState("dashboard");
    const [societies,setSocieties]=useState([]);
    const [wings,setWings]=useState([]);
    const [cameras,setCameras]=useState([]);
    const [users,setUsers]=useState([]);
    const [auditLogs,setAuditLogs]=useState([]);
    const [mgmtLoading,setMgmtLoading]=useState(false);
    const [logoUrl,setLogoUrl]=useState("");
    const [settings,setSettings]=useState({});
    const timer=useRef(null);
    const cid=user.role==="superuser"?client:user.client;

    // Load management data
    const loadMgmt=useCallback(async()=>{
      if(user.role!=="superuser"&&user.role!=="admin") return;
      setMgmtLoading(true);
      try{
        const promises=[
          apiFetch("/api/societies"),
          apiFetch("/api/wings"),
          apiFetch("/api/cameras"),
          apiFetch("/api/logs?limit=100"),
          apiFetch("/api/settings"),
        ];
        if(user.role==="superuser") promises.push(apiFetch("/api/users"));
        const [s,w,c,l,st,...rest]=await Promise.all(promises);
        setSocieties(s||[]);setWings(w||[]);setCameras(c||[]);
        setAuditLogs(l.logs||[]);setSettings(st||{});
        setLogoUrl(st.logo_url||"");
        if(rest[0]) setUsers(rest[0]||[]);
      }catch(e){console.error("mgmt load",e);}
      setMgmtLoading(false);
    },[user.role]);

    useEffect(()=>{ loadCameraNames(); },[]);
    useEffect(()=>{ if(activeTab==="management"||activeTab==="logs") loadMgmt(); },[activeTab]);

    const load=useCallback(async()=>{
      try{
        const [s,e]=await Promise.all([apiFetch("/api/stats?client_id="+cid),apiFetch("/api/events?client_id="+cid+"&limit=15")]);
        setStats(s);setEvents(e.events||[]);setOk(true);
        if(e.events&&e.events.length)setLog(e.events.slice(0,10).map(ev=>{
          const t=new Date(new Date(ev.timestamp_utc).getTime()+19800000).toLocaleTimeString("en-IN",{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:true,timeZone:"UTC"});
          return "["+t+" IST] "+ev.event_type.toUpperCase()+" @ "+ev.camera_location+(ev.visitor_count?" â€” "+ev.visitor_count+" person(s)":"");
        }));
      }catch(e){setOk(false);}finally{setLoading(false);}
    },[cid]);

    useEffect(()=>{load();timer.current=setInterval(load,15000);return()=>clearInterval(timer.current);},[load]);

    const copy=()=>{navigator.clipboard.writeText(BACKEND_URL+"/webhook");setCopied(true);setTimeout(()=>setCopied(false),2000);};

    const trend=stats?(vf==="today"?stats.trends.hourly.filter(h=>h.hour>=6):stats.trends.weekly):[];
    const cams=stats?stats.camera_activity:[];
    const down=(stats?stats.downtime:[]).map(d=>({...d,"Downtime (hrs)":parseFloat((d.downtime_minutes/60).toFixed(1))}));
    const top=cams&&cams[0];
    const todayV=stats?stats.visitors.today:0;
    const delta=todayV-(stats?stats.visitors.yesterday:0);
    const totalDT=down.reduce((s,c)=>s+c["Downtime (hrs)"],0).toFixed(1);
    const affCams=down.filter(c=>c.incidents>0).length;

    const roleColor=r=>r==="superuser"?"#c084fc":r==="admin"?"#38bdf8":"#4ade80";
    const roleBg=r=>r==="superuser"?"rgba(168,85,247,0.15)":r==="admin"?"rgba(56,189,248,0.15)":"rgba(34,197,94,0.15)";
    const roleBorder=r=>r==="superuser"?"rgba(168,85,247,0.3)":r==="admin"?"rgba(56,189,248,0.3)":"rgba(34,197,94,0.3)";

    const pill=(active,onClick,label)=>el("button",{style:{padding:"6px 14px",borderRadius:20,background:active?"rgba(56,189,248,0.15)":"rgba(30,41,59,0.5)",border:`1px solid ${active?"rgba(56,189,248,0.4)":"rgba(51,65,85,0.5)"}`,color:active?"#38bdf8":"#94a3b8",fontSize:12,fontWeight:600,cursor:"pointer"},onClick},label);
    const tog=(active,onClick,label)=>el("button",{style:{padding:"5px 12px",borderRadius:6,fontSize:11,fontWeight:600,border:"1px solid rgba(56,189,248,0.2)",background:active?"rgba(56,189,248,0.15)":"transparent",color:active?"#38bdf8":"#64748b",cursor:"pointer"},onClick},label);

    return el("div",{style:{minHeight:"100vh",background:"#0a0c10",color:"#e2e8f0"}},
      // NAV
      el("nav",{className:"sg-nav sg-nav-el",style:{background:"rgba(10,12,16,0.98)",borderBottom:"1px solid rgba(56,189,248,0.12)",padding:"0 24px",display:"flex",alignItems:"center",justifyContent:"space-between",height:60,position:"sticky",top:0,zIndex:100}},
        el("div",{className:"sg-nav-left",style:{display:"flex",alignItems:"center",gap:16}},
          el("span",{style:{fontSize:20}},"ðŸ¢"),
          el("span",{style:{fontSize:16,fontWeight:700,color:"#38bdf8"}},"SocietyGuard"),
          el("span",{style:{padding:"3px 10px",borderRadius:20,fontSize:10,fontWeight:700,letterSpacing:1,textTransform:"uppercase",background:roleBg(user.role),color:roleColor(user.role),border:`1px solid ${roleBorder(user.role)}`}},user.role),
          ok!==null&&el("span",{style:{display:"inline-flex",alignItems:"center",gap:6,padding:"4px 10px",borderRadius:20,fontSize:11,fontWeight:600,background:ok?"rgba(74,222,128,0.1)":"rgba(248,113,113,0.1)",color:ok?"#4ade80":"#f87171",border:`1px solid ${ok?"rgba(74,222,128,0.2)":"rgba(248,113,113,0.2)"}`}},
            el("span",{style:{width:6,height:6,borderRadius:"50%",background:ok?"#4ade80":"#f87171",display:"inline-block"}}),
            ok?"Live":"Backend Offline"
          )
        ),
        el("div",{className:"sg-nav-right",style:{display:"flex",alignItems:"center",gap:16}},
          user.role==="superuser"&&el("div",{style:{display:"flex",alignItems:"center",gap:8}},
            el("span",{style:{fontSize:11,color:"#64748b"}},"CLIENT:"),
            el("select",{style:{padding:"8px 12px",background:"rgba(15,23,36,0.95)",border:"1px solid rgba(56,189,248,0.2)",borderRadius:8,color:"#e2e8f0",fontSize:13,cursor:"pointer",outline:"none"},value:client,onChange:e=>setClient(e.target.value)},
              CLIENTS.map(c=>el("option",{key:c.id,value:c.id},c.name))
            )
          ),
          // Tab navigation
          el("div",{style:{display:"flex",gap:4}},
            ["dashboard","logs",...(user.role==="superuser"?["management"]:[])].map(tab=>
              el("button",{key:tab,style:{padding:"6px 14px",borderRadius:6,fontSize:12,fontWeight:600,cursor:"pointer",border:"none",background:activeTab===tab?"rgba(56,189,248,0.15)":"transparent",color:activeTab===tab?"#38bdf8":"#64748b",textTransform:"capitalize"},onClick:()=>setActiveTab(tab)},
                tab==="dashboard"?"ðŸ“Š Dashboard":tab==="logs"?"ðŸ“‹ Logs":"âš™ï¸ Manage"
              )
            )
          ),
          el("span",{style:{fontSize:13,color:"#94a3b8"}},"ðŸ‘¤ "+user.name),
          el("button",{style:{padding:"7px 16px",background:"transparent",border:"1px solid rgba(248,113,113,0.3)",borderRadius:6,color:"#f87171",fontSize:12,fontWeight:600,cursor:"pointer"},onClick:onLogout},"Sign Out")
        )
      ),

      el("main",{className:"sg-main",style:{padding:24,maxWidth:1400,margin:"0 auto"}},

        // â”€â”€ LOGS TAB â”€â”€
        activeTab==="logs"&&el("div",null,
          el("div",{style:{marginBottom:20}},
            el("div",{style:{fontSize:20,fontWeight:700,color:"#f1f5f9",marginBottom:4}},"ðŸ“‹ Audit Logs"),
            el("div",{style:{fontSize:13,color:"#64748b"}},"All system activity â€” logins, events, changes")
          ),
          mgmtLoading?el("div",{style:{textAlign:"center",padding:40,color:"#38bdf8"}},"â³ Loading..."):
          el("div",{className:"sg-card-el",style:{background:"rgba(15,23,36,0.9)",border:"1px solid rgba(56,189,248,0.1)",borderRadius:12,overflow:"hidden"}},
            el("table",{style:{width:"100%",borderCollapse:"collapse",fontSize:12}},
              el("thead",null,el("tr",null,
                ["Time (IST)","User","Role","Action","Entity","Details"].map(h=>el("th",{key:h,className:"sg-th-el",style:{padding:"12px 16px",textAlign:"left",color:"#64748b",fontSize:11,fontWeight:600,letterSpacing:1,textTransform:"uppercase",borderBottom:"1px solid rgba(51,65,85,0.5)"}},h))
              )),
              el("tbody",null,...(auditLogs.length?auditLogs:[ ]).map((l,i)=>
                el("tr",{key:i},
                  el("td",{className:"sg-td-el",style:{padding:"10px 16px",borderBottom:"1px solid rgba(51,65,85,0.2)",color:"#94a3b8",whiteSpace:"nowrap"}},
                    new Date(new Date(l.created_at).getTime()+19800000).toLocaleString("en-IN",{day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit",hour12:true,timeZone:"UTC"})
                  ),
                  el("td",{className:"sg-td-el",style:{padding:"10px 16px",borderBottom:"1px solid rgba(51,65,85,0.2)",color:"#38bdf8",fontWeight:600}},l.username||"system"),
                  el("td",{className:"sg-td-el",style:{padding:"10px 16px",borderBottom:"1px solid rgba(51,65,85,0.2)"}},
                    el("span",{style:{padding:"2px 8px",borderRadius:4,fontSize:10,fontWeight:700,background:l.role==="superuser"?"rgba(192,132,252,0.15)":l.role==="admin"?"rgba(56,189,248,0.15)":"rgba(74,222,128,0.1)",color:l.role==="superuser"?"#c084fc":l.role==="admin"?"#38bdf8":"#4ade80"}},l.role||"â€”")
                  ),
                  el("td",{className:"sg-td-el",style:{padding:"10px 16px",borderBottom:"1px solid rgba(51,65,85,0.2)",color:"#e2e8f0"}},l.action),
                  el("td",{className:"sg-td-el",style:{padding:"10px 16px",borderBottom:"1px solid rgba(51,65,85,0.2)",color:"#64748b"}},l.entity||"â€”"),
                  el("td",{className:"sg-td-el",style:{padding:"10px 16px",borderBottom:"1px solid rgba(51,65,85,0.2)",color:"#475569",maxWidth:200,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},
                    typeof l.details==="object"?JSON.stringify(l.details):l.details||"â€”"
                  )
                )
              ))
            ),
            auditLogs.length===0&&el("div",{style:{textAlign:"center",padding:40,color:"#475569"}},"No logs yet")
          )
        ),

        // â”€â”€ MANAGEMENT TAB â”€â”€
        activeTab==="management"&&user.role==="superuser"&&el("div",null,
          el("div",{style:{marginBottom:20}},
            el("div",{style:{fontSize:20,fontWeight:700,color:"#f1f5f9",marginBottom:4}},"âš™ï¸ Management"),
            el("div",{style:{fontSize:13,color:"#64748b"}},"Manage societies, wings, cameras and users")
          ),
          mgmtLoading?el("div",{style:{textAlign:"center",padding:40,color:"#38bdf8"}},"â³ Loading..."):
          el("div",null,

            // â”€â”€ LOGO UPLOAD â”€â”€
            el("div",{className:"sg-card-el",style:{background:"rgba(15,23,36,0.9)",border:"1px solid rgba(56,189,248,0.1)",borderRadius:12,padding:20,marginBottom:20}},
              el("div",{style:{fontSize:14,fontWeight:700,color:"#38bdf8",marginBottom:12}},"ðŸ¢ Company Logo"),
              el("div",{style:{display:"flex",alignItems:"center",gap:12,flexWrap:"wrap"}},
                logoUrl&&el("img",{src:logoUrl,style:{height:48,borderRadius:8,border:"1px solid rgba(56,189,248,0.2)"}}),
                el("input",{className:"sg-input-el",style:{flex:1,minWidth:250,padding:"10px 14px",background:"rgba(30,41,59,0.8)",border:"1px solid rgba(51,65,85,0.8)",borderRadius:8,color:"#e2e8f0",fontSize:13,outline:"none"},value:logoUrl,onChange:e=>setLogoUrl(e.target.value),placeholder:"Paste logo image URL (https://...)"}),
                el("button",{style:{padding:"10px 20px",background:"linear-gradient(135deg,#0ea5e9,#38bdf8)",border:"none",borderRadius:8,color:"#0a0c10",fontSize:13,fontWeight:700,cursor:"pointer"},onClick:async()=>{
                  try{await apiFetch("/api/settings",{method:"POST",body:JSON.stringify({key:"logo_url",value:logoUrl})});alert("Logo saved!");}catch(e){alert("Error: "+e.message);}
                }},"Save Logo")
              )
            ),

            // â”€â”€ SOCIETIES â”€â”€
            el("div",{className:"sg-card-el",style:{background:"rgba(15,23,36,0.9)",border:"1px solid rgba(56,189,248,0.1)",borderRadius:12,padding:20,marginBottom:20}},
              el("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}},
                el("div",{style:{fontSize:14,fontWeight:700,color:"#38bdf8"}},"ðŸ˜ï¸ Societies ("+societies.length+")"),
                el("button",{style:{padding:"8px 16px",background:"rgba(56,189,248,0.1)",border:"1px solid rgba(56,189,248,0.3)",borderRadius:8,color:"#38bdf8",fontSize:12,fontWeight:600,cursor:"pointer"},
                  onClick:async()=>{
                    const code=prompt("Society Code (e.g. C04):");
                    const name=prompt("Society Name:");
                    const addr=prompt("Address (optional):");
                    if(!code||!name) return;
                    try{await apiFetch("/api/societies",{method:"POST",body:JSON.stringify({code,name,address:addr})});loadMgmt();}catch(e){alert("Error: "+e.message);}
                  }},"+ Add Society")
              ),
              el("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(240px,1fr))",gap:12}},
                ...societies.map(s=>el("div",{key:s.id,style:{background:"rgba(10,12,16,0.6)",border:"1px solid rgba(51,65,85,0.4)",borderRadius:8,padding:14}},
                  el("div",{style:{fontWeight:700,color:"#e2e8f0",marginBottom:4}},s.name),
                  el("div",{style:{fontSize:11,color:"#38bdf8",marginBottom:8}},"Code: "+s.code),
                  el("div",{style:{fontSize:11,color:"#64748b",marginBottom:8}},s.address||"No address"),
                  el("div",{style:{fontSize:11,color:"#94a3b8"}},s.user_count+" users Â· "+s.camera_count+" cameras"),
                  el("div",{style:{display:"flex",gap:8,marginTop:10}},
                    el("button",{style:{fontSize:11,padding:"4px 10px",borderRadius:4,background:"rgba(248,113,113,0.1)",border:"1px solid rgba(248,113,113,0.3)",color:"#f87171",cursor:"pointer"},
                      onClick:async()=>{if(!confirm("Delete "+s.name+"?"))return;try{await apiFetch("/api/societies/"+s.id,{method:"DELETE"});loadMgmt();}catch(e){alert(e.message);}}},"Delete")
                  )
                ))
              )
            ),

            // â”€â”€ CAMERAS â”€â”€
            el("div",{className:"sg-card-el",style:{background:"rgba(15,23,36,0.9)",border:"1px solid rgba(56,189,248,0.1)",borderRadius:12,padding:20,marginBottom:20}},
              el("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}},
                el("div",{style:{fontSize:14,fontWeight:700,color:"#38bdf8"}},"ðŸ“· Cameras ("+cameras.length+")"),
                el("button",{style:{padding:"8px 16px",background:"rgba(56,189,248,0.1)",border:"1px solid rgba(56,189,248,0.3)",borderRadius:8,color:"#38bdf8",fontSize:12,fontWeight:600,cursor:"pointer"},
                  onClick:async()=>{
                    const uid=prompt("Camera UID (from 3deye deviceId, e.g. 93518):");
                    const name=prompt("Camera Name (e.g. Main Gate):");
                    const loc=prompt("Location description:");
                    const soc=societies.find(s=>s.name===prompt("Society code: "+societies.map(s=>s.code).join(", ")));
                    if(!uid||!name) return;
                    try{await apiFetch("/api/cameras",{method:"POST",body:JSON.stringify({camera_uid:uid,name,location:loc,society_id:soc?.id})});loadMgmt();loadCameraNames();}catch(e){alert("Error: "+e.message);}
                  }},"+ Add Camera")
              ),
              el("table",{style:{width:"100%",borderCollapse:"collapse",fontSize:13}},
                el("thead",null,el("tr",null,["UID","Name","Society","Location",""].map(h=>el("th",{key:h,className:"sg-th-el",style:{padding:"10px 12px",textAlign:"left",color:"#64748b",fontSize:11,fontWeight:600,letterSpacing:1,textTransform:"uppercase",borderBottom:"1px solid rgba(51,65,85,0.4)"}},h)))),
                el("tbody",null,...cameras.map((c,i)=>el("tr",{key:i},
                  el("td",{className:"sg-td-el",style:{padding:"10px 12px",borderBottom:"1px solid rgba(51,65,85,0.2)",color:"#38bdf8",fontFamily:"monospace"}},c.camera_uid),
                  el("td",{className:"sg-td-el",style:{padding:"10px 12px",borderBottom:"1px solid rgba(51,65,85,0.2)",color:"#e2e8f0",fontWeight:600}},c.name),
                  el("td",{className:"sg-td-el",style:{padding:"10px 12px",borderBottom:"1px solid rgba(51,65,85,0.2)",color:"#94a3b8"}},c.society_name||"â€”"),
                  el("td",{className:"sg-td-el",style:{padding:"10px 12px",borderBottom:"1px solid rgba(51,65,85,0.2)",color:"#64748b"}},c.location||"â€”"),
                  el("td",{className:"sg-td-el",style:{padding:"10px 12px",borderBottom:"1px solid rgba(51,65,85,0.2)"}},
                    el("button",{style:{fontSize:11,padding:"3px 10px",borderRadius:4,background:"rgba(248,113,113,0.1)",border:"1px solid rgba(248,113,113,0.3)",color:"#f87171",cursor:"pointer"},
                      onClick:async()=>{if(!confirm("Delete camera "+c.name+"?"))return;try{await apiFetch("/api/cameras/"+c.id,{method:"DELETE"});loadMgmt();loadCameraNames();}catch(e){alert(e.message);}}},"Delete")
                  )
                )))
              )
            ),

            // â”€â”€ USERS â”€â”€
            el("div",{className:"sg-card-el",style:{background:"rgba(15,23,36,0.9)",border:"1px solid rgba(56,189,248,0.1)",borderRadius:12,padding:20,marginBottom:20}},
              el("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}},
                el("div",{style:{fontSize:14,fontWeight:700,color:"#38bdf8"}},"ðŸ‘¥ Users ("+users.length+")"),
                el("button",{style:{padding:"8px 16px",background:"rgba(56,189,248,0.1)",border:"1px solid rgba(56,189,248,0.3)",borderRadius:8,color:"#38bdf8",fontSize:12,fontWeight:600,cursor:"pointer"},
                  onClick:async()=>{
                    const name=prompt("Full Name:");
                    const username=prompt("Username:");
                    const email=prompt("Email address (invite will be sent here):");
                    const role=prompt("Role (admin/operator):");
                    const socCode=prompt("Society code: "+societies.map(s=>s.code).join(", "));
                    const soc=societies.find(s=>s.code===socCode?.toUpperCase());
                    if(!name||!username||!email||!role) return;
                    try{
                      const r=await apiFetch("/api/users",{method:"POST",body:JSON.stringify({name,username,email,role,society_id:soc?.id})});
                      alert("User created! Invite email sent to "+email);
                      loadMgmt();
                    }catch(e){alert("Error: "+e.message);}
                  }},"+ Add User")
              ),
              el("table",{style:{width:"100%",borderCollapse:"collapse",fontSize:13}},
                el("thead",null,el("tr",null,["Name","Username","Role","Society","Email","Status","Actions"].map(h=>el("th",{key:h,className:"sg-th-el",style:{padding:"10px 12px",textAlign:"left",color:"#64748b",fontSize:11,fontWeight:600,letterSpacing:1,textTransform:"uppercase",borderBottom:"1px solid rgba(51,65,85,0.4)"}},h)))),
                el("tbody",null,...users.map((u,i)=>el("tr",{key:i},
                  el("td",{className:"sg-td-el",style:{padding:"10px 12px",borderBottom:"1px solid rgba(51,65,85,0.2)",color:"#e2e8f0",fontWeight:600}},u.name),
                  el("td",{className:"sg-td-el",style:{padding:"10px 12px",borderBottom:"1px solid rgba(51,65,85,0.2)",color:"#38bdf8",fontFamily:"monospace"}},u.username),
                  el("td",{className:"sg-td-el",style:{padding:"10px 12px",borderBottom:"1px solid rgba(51,65,85,0.2)"}},
                    el("span",{style:{padding:"2px 8px",borderRadius:4,fontSize:10,fontWeight:700,background:u.role==="superuser"?"rgba(192,132,252,0.15)":u.role==="admin"?"rgba(56,189,248,0.15)":"rgba(74,222,128,0.1)",color:u.role==="superuser"?"#c084fc":u.role==="admin"?"#38bdf8":"#4ade80"}},u.role)
                  ),
                  el("td",{className:"sg-td-el",style:{padding:"10px 12px",borderBottom:"1px solid rgba(51,65,85,0.2)",color:"#94a3b8"}},u.society_name||"All"),
                  el("td",{className:"sg-td-el",style:{padding:"10px 12px",borderBottom:"1px solid rgba(51,65,85,0.2)",color:"#64748b",fontSize:11}},u.email),
                  el("td",{className:"sg-td-el",style:{padding:"10px 12px",borderBottom:"1px solid rgba(51,65,85,0.2)"}},
                    el("span",{style:{padding:"2px 8px",borderRadius:4,fontSize:10,fontWeight:700,background:u.is_active?"rgba(74,222,128,0.1)":"rgba(248,113,113,0.1)",color:u.is_active?"#4ade80":"#f87171"}},u.is_active?"Active":"Inactive")
                  ),
                  el("td",{className:"sg-td-el",style:{padding:"10px 12px",borderBottom:"1px solid rgba(51,65,85,0.2)"}},
                    el("div",{style:{display:"flex",gap:6}},
                      el("button",{style:{fontSize:11,padding:"3px 8px",borderRadius:4,background:"rgba(56,189,248,0.1)",border:"1px solid rgba(56,189,248,0.3)",color:"#38bdf8",cursor:"pointer"},
                        onClick:async()=>{try{await apiFetch("/api/users/"+u.id+"/resend-invite",{method:"POST"});alert("Invite resent!");}catch(e){alert(e.message);}}},"Resend Invite"),
                      u.is_active&&el("button",{style:{fontSize:11,padding:"3px 8px",borderRadius:4,background:"rgba(248,113,113,0.1)",border:"1px solid rgba(248,113,113,0.3)",color:"#f87171",cursor:"pointer"},
                        onClick:async()=>{if(!confirm("Deactivate "+u.name+"?"))return;try{await apiFetch("/api/users/"+u.id,{method:"DELETE"});loadMgmt();}catch(e){alert(e.message);}}},"Deactivate")
                    )
                  )
                )))
              )
            )
          )
        ),

        // â”€â”€ DASHBOARD TAB â”€â”€
        activeTab==="dashboard"&&el("div",null,
        // Header
        el("div",{style:{marginBottom:24}},
          el("div",{style:{fontSize:22,fontWeight:700,color:"#f1f5f9",letterSpacing:-0.5,marginBottom:4}},(CLIENTS.find(c=>c.id===cid)||{name:"Dashboard"}).name),
          el("div",{style:{fontSize:13,color:"#64748b"}},new Date().toLocaleDateString("en-IN",{weekday:"long",year:"numeric",month:"long",day:"numeric"})+" Â· All times in IST")
        ),

        // Webhook Panel â€” superuser only
        user.role==="superuser"&&el("div",{className:"sg-webhook-el",style:{background:"rgba(10,12,16,0.95)",border:"1px solid rgba(56,189,248,0.1)",borderRadius:12,padding:16,marginBottom:24}},
          el("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}},
            el("span",{style:{fontSize:12,color:"#38bdf8",fontWeight:700,letterSpacing:2}},"âš¡ WEBHOOK ENDPOINT"),
            el("span",{style:{fontSize:11,color:"#64748b"}},"Auto-refreshes every 15s")
          ),
          el("div",{className:"sg-webhook-url",style:{background:"rgba(30,41,59,0.5)",border:"1px solid rgba(56,189,248,0.15)",borderRadius:8,padding:"12px 16px",fontFamily:"monospace",fontSize:12,color:"#38bdf8",display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:10}},
            el("span",null,"POST   "+BACKEND_URL+"/webhook"),
            el("button",{style:{padding:"4px 10px",background:"rgba(56,189,248,0.1)",border:"1px solid rgba(56,189,248,0.3)",borderRadius:4,color:"#38bdf8",fontSize:11,cursor:"pointer",fontWeight:600},onClick:copy},copied?"âœ“ Copied":"Copy")
          ),
          el("div",{style:{fontSize:10,color:"#64748b",letterSpacing:1,marginBottom:4}},"LIVE EVENT LOG"),
          el("div",{style:{maxHeight:120,overflowY:"auto",fontFamily:"monospace",fontSize:11}},
            log.length===0
              ?el("span",{style:{color:"#475569"}},"No events yet. Send a POST to the webhook URL above.")
              :log.map((l,i)=>el("div",{key:i,style:{color:i===0?"#4ade80":"#475569",marginBottom:2}},l))
          )
        ),

        loading?el("div",{style:{textAlign:"center",padding:40,color:"#38bdf8"}},"â³ Loading data..."):

        el(React.Fragment,null,
          // Stats
          el("div",{className:"sg-stats-grid",style:{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(200px,1fr))",gap:16,marginBottom:24}},
            el(StatCard,{label:"Today's Visitors",value:todayV,delta:Math.abs(delta)+" vs yesterday",pos:delta>=0,accent:"#38bdf8",icon:"ðŸ‘ï¸"}),
            el(StatCard,{label:"This Week",value:stats?stats.visitors.week:0,accent:"#818cf8",icon:"ðŸ“…"}),
            el(StatCard,{label:"Busiest Camera",value:top?top.camera_id:"â€”",delta:top?top.count+" events Â· "+top.location:"No data",pos:false,accent:"#fb923c",icon:"ðŸ“·"}),
            el(StatCard,{label:"Total Downtime",value:totalDT+"h",delta:affCams+" camera"+(affCams!==1?"s":"")+" affected",pos:false,accent:"#f87171",icon:"âš ï¸"})
          ),

          // Chart Grid
          el("div",{className:"sg-chart-grid",style:{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(420px,1fr))",gap:20,marginBottom:24}},
            // Visitor Trends
            el("div",{style:{background:"rgba(15,23,36,0.9)",border:"1px solid rgba(56,189,248,0.1)",borderRadius:12,padding:"20px 24px"}},
              el("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:20,flexWrap:"wrap",gap:10}},
                el("div",null,
                  el("div",{style:{fontSize:14,fontWeight:700,color:"#e2e8f0"}},"Visitor Trends"),
                  el("div",{style:{fontSize:11,color:"#64748b",marginTop:2}},"IST Â· from webhook data")
                ),
                el("div",{style:{display:"flex",gap:8,flexWrap:"wrap"}},
                  el("div",{style:{display:"flex",gap:8}},
                    pill(vf==="today",()=>setVf("today"),"Today vs Yesterday"),
                    pill(vf==="week",()=>setVf("week"),"Week by Week")
                  ),
                  el("div",{style:{display:"flex",gap:4}},
                    tog(vc==="Bar",()=>setVc("Bar"),"Bar"),
                    tog(vc==="Pie",()=>setVc("Pie"),"Pie")
                  )
                )
              ),
              trend.length===0
                ?el("div",{style:{textAlign:"center",padding:40,color:"#475569",fontSize:12}},"No visitor events yet")
                :el(ResponsiveContainer,{width:"100%",height:220},
                  vc==="Bar"
                    ?el(BarChart,{data:trend,barSize:14},
                        el(CartesianGrid,{strokeDasharray:"3 3",stroke:"rgba(51,65,85,0.4)"}),
                        el(XAxis,{dataKey:"label",tick:{fill:"#64748b",fontSize:10}}),
                        el(YAxis,{tick:{fill:"#64748b",fontSize:10}}),
                        el(Tooltip,tt),
                        el(Legend,null),
                        vf==="week"
                          ?el(Bar,{dataKey:"visitors",fill:"#38bdf8",radius:[4,4,0,0]})
                          :el(React.Fragment,null,
                              el(Bar,{dataKey:"today",name:"Today",fill:"#38bdf8",radius:[4,4,0,0]}),
                              el(Bar,{dataKey:"yesterday",name:"Yesterday",fill:"#818cf8",radius:[4,4,0,0]})
                            )
                      )
                    :el(PieChart,null,
                        el(Pie,{data:trend.filter(d=>(d.today||d.visitors||0)>0),dataKey:vf==="week"?"visitors":"today",nameKey:"label",cx:"50%",cy:"50%",outerRadius:80,label:({name,percent})=>name+" "+(percent*100).toFixed(0)+"%",labelLine:false},
                          trend.map((_,i)=>el(Cell,{key:i,fill:COLORS[i%COLORS.length]}))
                        ),
                        el(Tooltip,tt)
                      )
                )
            ),

            // Camera Activity
            el("div",{style:{background:"rgba(15,23,36,0.9)",border:"1px solid rgba(56,189,248,0.1)",borderRadius:12,padding:"20px 24px"}},
              el("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:20}},
                el("div",null,
                  el("div",{style:{fontSize:14,fontWeight:700,color:"#e2e8f0"}},"Camera Activity"),
                  el("div",{style:{fontSize:11,color:"#64748b",marginTop:2}},"Events this week")
                ),
                el("div",{style:{display:"flex",gap:4}},
                  tog(cc==="Bar",()=>setCc("Bar"),"Bar"),
                  tog(cc==="Pie",()=>setCc("Pie"),"Pie")
                )
              ),
              cams.length===0
                ?el("div",{style:{textAlign:"center",padding:40,color:"#475569",fontSize:12}},"No camera events yet")
                :el(ResponsiveContainer,{width:"100%",height:220},
                  cc==="Bar"
                    ?el(BarChart,{data:cams,layout:"vertical",barSize:14},
                        el(CartesianGrid,{strokeDasharray:"3 3",stroke:"rgba(51,65,85,0.4)",horizontal:false}),
                        el(XAxis,{type:"number",tick:{fill:"#64748b",fontSize:10}}),
                        el(YAxis,{type:"category",dataKey:"camera_id",tick:{fill:"#64748b",fontSize:10},width:60}),
                        el(Tooltip,{...tt,formatter:(v,_,p)=>[v,p.payload.location]}),
                        el(Bar,{dataKey:"count",name:"Events",radius:[0,4,4,0]},
                          cams.map((_,i)=>el(Cell,{key:i,fill:i===0?"#fb923c":COLORS[i%COLORS.length]}))
                        )
                      )
                    :el(PieChart,null,
                        el(Pie,{data:cams,dataKey:"count",nameKey:"camera_id",cx:"50%",cy:"50%",outerRadius:80,label:({name,percent})=>name+" "+(percent*100).toFixed(0)+"%",labelLine:false},
                          cams.map((_,i)=>el(Cell,{key:i,fill:i===0?"#fb923c":COLORS[i%COLORS.length]}))
                        ),
                        el(Tooltip,tt)
                      )
                ),
              top&&el("div",{style:{marginTop:12,padding:"10px 14px",background:"rgba(251,146,60,0.08)",border:"1px solid rgba(251,146,60,0.2)",borderRadius:8,fontSize:12,color:"#fdba74"}},
                "ðŸš¨ ",el("strong",null,top.camera_id+" ("+top.location+")")," â€” highest activity, consider deploying guard"
              )
            )
          ),

          // Downtime
          el("div",{className:"sg-card-el",style:{background:"rgba(15,23,36,0.9)",border:"1px solid rgba(56,189,248,0.1)",borderRadius:12,padding:"20px 24px",marginBottom:24}},
            el("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:20}},
              el("div",null,
                el("div",{style:{fontSize:14,fontWeight:700,color:"#e2e8f0"}},"Camera Downtime"),
                el("div",{style:{fontSize:11,color:"#64748b",marginTop:2}},"From camera_offline events Â· UTCâ†’IST")
              ),
              el("div",{style:{display:"flex",gap:4}},
                tog(dc==="Bar",()=>setDc("Bar"),"Bar"),
                tog(dc==="Pie",()=>setDc("Pie"),"Pie")
              )
            ),
            down.length===0
              ?el("div",{style:{textAlign:"center",padding:40,color:"#475569",fontSize:12}},"No camera_offline events yet")
              :el(ResponsiveContainer,{width:"100%",height:200},
                dc==="Bar"
                  ?el(BarChart,{data:down,barSize:20},
                      el(CartesianGrid,{strokeDasharray:"3 3",stroke:"rgba(51,65,85,0.4)"}),
                      el(XAxis,{dataKey:"camera_id",tick:{fill:"#64748b",fontSize:11}}),
                      el(YAxis,{tick:{fill:"#64748b",fontSize:11},unit:"h"}),
                      el(Tooltip,{...tt,formatter:(v,_,p)=>[v+"h ("+p.payload.incidents+" incidents)",p.payload.location||p.payload.camera_id]}),
                      el(Bar,{dataKey:"Downtime (hrs)",radius:[4,4,0,0]},
                        down.map((d,i)=>el(Cell,{key:i,fill:d["Downtime (hrs)"]>1?"#f87171":"#34d399"}))
                      )
                    )
                  :el(PieChart,null,
                      el(Pie,{data:down.filter(d=>d["Downtime (hrs)"]>0),dataKey:"Downtime (hrs)",nameKey:"camera_id",cx:"50%",cy:"50%",outerRadius:80,label:({name,percent})=>name+" "+(percent*100).toFixed(0)+"%",labelLine:false},
                        down.map((_,i)=>el(Cell,{key:i,fill:COLORS[i%COLORS.length]}))
                      ),
                      el(Tooltip,tt)
                    )
              )
          ),

          // Camera Table
          down.length>0&&el("div",{className:"sg-table-wrap sg-card-el",style:{background:"rgba(15,23,36,0.9)",border:"1px solid rgba(56,189,248,0.1)",borderRadius:12,overflow:"hidden",marginBottom:24}},
            el("div",{style:{padding:"16px 24px",display:"flex",justifyContent:"space-between",borderBottom:"1px solid rgba(56,189,248,0.08)"}},
              el("span",{style:{fontSize:14,fontWeight:700,color:"#e2e8f0"}},"Camera Status"),
              el("span",{style:{fontSize:11,color:"#64748b"}},"camera_offline / camera_online events")
            ),
            el("table",{style:{width:"100%",borderCollapse:"collapse",fontSize:13}},
              el("thead",null,el("tr",null,["Camera","Location","Incidents","Downtime","Status"].map(h=>el("th",{key:h,className:"sg-th-el",style:{padding:"12px 16px",textAlign:"left",color:"#64748b",fontSize:11,fontWeight:600,letterSpacing:1,textTransform:"uppercase",borderBottom:"1px solid rgba(51,65,85,0.5)"}},h)))),
              el("tbody",null,...down.sort((a,b)=>b["Downtime (hrs)"]-a["Downtime (hrs)"]).map((c,i)=>
                el("tr",{key:i},
                  el("td",{style:{padding:"12px 16px",borderBottom:"1px solid rgba(51,65,85,0.3)",color:"#cbd5e1"}},el("strong",{style:{color:"#e2e8f0"}},c.camera_id)),
                  el("td",{style:{padding:"12px 16px",borderBottom:"1px solid rgba(51,65,85,0.3)",color:"#cbd5e1"}},c.location||c.camera_id),
                  el("td",{style:{padding:"12px 16px",borderBottom:"1px solid rgba(51,65,85,0.3)",color:"#cbd5e1"}},c.incidents),
                  el("td",{style:{padding:"12px 16px",borderBottom:"1px solid rgba(51,65,85,0.3)",color:"#cbd5e1"}},c["Downtime (hrs)"]+"h"),
                  el("td",{style:{padding:"12px 16px",borderBottom:"1px solid rgba(51,65,85,0.3)",fontSize:11,color:c["Downtime (hrs)"]>1?"#fbbf24":"#4ade80"}},c["Downtime (hrs)"]>1?"âš ï¸ Maintenance needed":"âœ… Healthy")
                )
              ))
            )
          ),

          // Events Feed
          (user.role==="admin"||user.role==="superuser")&&events.length>0&&
          el("div",{className:"sg-table-wrap sg-card-el",style:{background:"rgba(15,23,36,0.9)",border:"1px solid rgba(56,189,248,0.1)",borderRadius:12,overflow:"hidden",marginBottom:24}},
            el("div",{style:{padding:"16px 24px",display:"flex",justifyContent:"space-between",borderBottom:"1px solid rgba(56,189,248,0.08)"}},
              el("span",{style:{fontSize:14,fontWeight:700,color:"#e2e8f0"}},"Recent Events"),
              el("span",{style:{fontSize:11,color:"#64748b"}},"Last 15 Â· UTCâ†’IST")
            ),
            el("table",{style:{width:"100%",borderCollapse:"collapse",fontSize:13}},
              el("thead",null,el("tr",null,["IST Time","Camera","Location","Event","Count"].map(h=>el("th",{key:h,className:"sg-th-el",style:{padding:"12px 16px",textAlign:"left",color:"#64748b",fontSize:11,fontWeight:600,letterSpacing:1,textTransform:"uppercase",borderBottom:"1px solid rgba(51,65,85,0.5)"}},h)))),
              el("tbody",null,...events.map((e,i)=>
                el("tr",{key:i},
                  el("td",{style:{padding:"10px 16px",borderBottom:"1px solid rgba(51,65,85,0.3)",color:"#cbd5e1"}},
                    e.thumbnail_url&&el("a",{href:e.video_url||e.thumbnail_url,target:"_blank",rel:"noopener"},
                      el("img",{src:e.thumbnail_url,style:{width:72,height:44,objectFit:"cover",borderRadius:5,border:"1px solid rgba(56,189,248,0.2)",cursor:"pointer",display:"block",marginBottom:4},
                        onError:ev=>{ev.target.style.display="none";}})
                    ),
                    el("span",{style:{fontSize:11,whiteSpace:"nowrap"}},(()=>{const d=new Date(new Date(e.timestamp_utc).getTime()+19800000);return d.toLocaleString("en-IN",{hour:"2-digit",minute:"2-digit",day:"2-digit",month:"short",hour12:true,timeZone:"UTC"});})())
                  ),
                  el("td",{style:{padding:"10px 16px",borderBottom:"1px solid rgba(51,65,85,0.3)",color:"#cbd5e1"}},el("span",{style:{color:"#38bdf8",fontWeight:600}},getCameraName(e.camera_id))),
                  el("td",{style:{padding:"10px 16px",borderBottom:"1px solid rgba(51,65,85,0.3)",color:"#cbd5e1"}},getCameraName(e.camera_id)),
                  el("td",{style:{padding:"10px 16px",borderBottom:"1px solid rgba(51,65,85,0.3)",color:"#cbd5e1"}},
                    el("span",{style:{padding:"2px 8px",borderRadius:4,fontSize:11,fontWeight:600,background:e.event_type==="camera_offline"?"rgba(248,113,113,0.15)":e.event_type==="loitering"?"rgba(251,191,36,0.15)":"rgba(56,189,248,0.1)",color:e.event_type==="camera_offline"?"#f87171":e.event_type==="loitering"?"#fbbf24":"#38bdf8"}},e.event_type.replace(/_/g," "))
                  ),
                  el("td",{style:{padding:"10px 16px",borderBottom:"1px solid rgba(51,65,85,0.3)",color:"#cbd5e1"}},e.visitor_count||"â€”")
                )
              ))
            )
          )
        )
      )
    );
  }

  // â”€â”€ SET PASSWORD PAGE â”€â”€
  function SetPasswordPage({token,onDone}){
    const [pw,setPw]=useState("");const [pw2,setPw2]=useState("");const [msg,setMsg]=useState("");const [err,setErr]=useState("");const [loading,setLoading]=useState(false);
    const submit=async()=>{
      if(pw.length<8){setErr("Password must be at least 8 characters");return;}
      if(pw!==pw2){setErr("Passwords do not match");return;}
      setLoading(true);setErr("");
      try{
        const r=await fetch(BACKEND_URL+"/api/set-password",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":API_KEY},body:JSON.stringify({token,password:pw})});
        const d=await r.json();
        if(!r.ok){setErr(d.error||"Failed");return;}
        setMsg("Password set! Redirecting to login...");
        setTimeout(()=>{window.history.replaceState({},"","/");onDone();},2000);
      }catch(e){setErr("Error: "+e.message);}finally{setLoading(false);}
    };
    return el("div",{className:"sg-login-bg",style:{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",background:"linear-gradient(135deg,#0a0c10,#0d1117,#0f1923)"}},
      el("div",{className:"sg-login-card sg-login-card-el",style:{background:"rgba(15,23,36,0.95)",border:"1px solid rgba(56,189,248,0.2)",borderRadius:16,padding:"48px 40px",width:400,boxShadow:"0 0 60px rgba(56,189,248,0.08)"}},
        el("div",{style:{display:"flex",alignItems:"center",gap:10,marginBottom:32}},
          el("div",{style:{width:40,height:40,background:"linear-gradient(135deg,#38bdf8,#0ea5e9)",borderRadius:10,display:"flex",alignItems:"center",justifyContent:"center",fontSize:20}},"ðŸ”"),
          el("div",null,
            el("div",{style:{fontSize:18,fontWeight:700,color:"#38bdf8"}},"Set Your Password"),
            el("div",{style:{fontSize:11,color:"#64748b",letterSpacing:2,textTransform:"uppercase"}},"Account Activation")
          )
        ),
        msg?el("div",{style:{padding:16,background:"rgba(74,222,128,0.1)",border:"1px solid rgba(74,222,128,0.3)",borderRadius:8,color:"#4ade80",textAlign:"center"}},msg):
        el("div",null,
          el("div",{style:{marginBottom:16}},
            el("label",{style:{display:"block",fontSize:11,fontWeight:600,color:"#64748b",letterSpacing:1,marginBottom:8,textTransform:"uppercase"}},"New Password"),
            el("input",{className:"sg-input-el",type:"password",style:{width:"100%",padding:"12px 14px",background:"rgba(30,41,59,0.8)",border:"1px solid rgba(51,65,85,0.8)",borderRadius:8,color:"#e2e8f0",fontSize:14,outline:"none"},value:pw,onChange:e=>setPw(e.target.value),placeholder:"Min 8 characters"})
          ),
          el("div",{style:{marginBottom:20}},
            el("label",{style:{display:"block",fontSize:11,fontWeight:600,color:"#64748b",letterSpacing:1,marginBottom:8,textTransform:"uppercase"}},"Confirm Password"),
            el("input",{className:"sg-input-el",type:"password",style:{width:"100%",padding:"12px 14px",background:"rgba(30,41,59,0.8)",border:"1px solid rgba(51,65,85,0.8)",borderRadius:8,color:"#e2e8f0",fontSize:14,outline:"none"},value:pw2,onChange:e=>setPw2(e.target.value),placeholder:"Repeat password"})
          ),
          err&&el("div",{style:{padding:"10px 14px",background:"rgba(248,113,113,0.1)",border:"1px solid rgba(248,113,113,0.2)",borderRadius:6,color:"#f87171",fontSize:13,marginBottom:16}},err),
          el("button",{style:{width:"100%",padding:13,background:"linear-gradient(135deg,#0ea5e9,#38bdf8)",border:"none",borderRadius:8,color:"#0a0c10",fontSize:14,fontWeight:700,cursor:"pointer",opacity:loading?0.7:1},onClick:submit,disabled:loading},loading?"Setting password...":"Activate Account â†’")
        )
      )
    );
  }

  // â”€â”€ APP â”€â”€
  function App(){
    const {useState:us,useEffect:ue}=React;
    const [user,setUser]=us(null);
    const [inviteToken,setInviteToken]=us(null);
    ue(()=>{
      const p=new URLSearchParams(window.location.search);
      const t=p.get("invite");
      if(t) setInviteToken(t);
    },[]);
    if(inviteToken) return el(SetPasswordPage,{token:inviteToken,onDone:()=>setInviteToken(null)});
    return user
      ?el(Dashboard,{user,onLogout:()=>setUser(null)})
      :el(LoginPage,{onLogin:u=>{window._sgUserId=u.id;setUser(u);}});
  }

  ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
}

waitAndBoot(0);
</script>
</body>
</html>
