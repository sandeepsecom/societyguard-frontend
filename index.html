<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SocietyGuard â€” Security Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
  <script src="https://unpkg.com/recharts@2.5.0/umd/Recharts.js"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:#0a0c10;font-family:'Segoe UI',sans-serif;color:#e2e8f0}
    ::-webkit-scrollbar{width:6px;height:6px}
    ::-webkit-scrollbar-track{background:#0a0c10}
    ::-webkit-scrollbar-thumb{background:#1e293b;border-radius:3px}
    select option{background:#0f1923}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
<div id="root"><div style="display:flex;align-items:center;justify-content:center;height:100vh;color:#38bdf8;font-size:14px">Loading SocietyGuard...</div></div>
<script>
// â”€â”€ CONFIG â”€â”€
const BACKEND_URL = "https://societyguard-backend.onrender.com";
const API_KEY = "sg-mysociety-2026";

const CLIENTS = [
  {id:"C01",name:"Green Valley Society"},
  {id:"C02",name:"Sunrise Heights"},
  {id:"C03",name:"Royal Palms"},
];
// Users authenticated via backend API
const COLORS=["#38bdf8","#818cf8","#34d399","#fb923c","#f472b6","#a78bfa"];

async function apiFetch(path){
  const r=await fetch(BACKEND_URL+path,{headers:{"x-api-key":API_KEY,"Content-Type":"application/json"}});
  if(!r.ok)throw new Error(r.status);
  return r.json();
}

// â”€â”€ Wait for Recharts to load then boot app â”€â”€
function waitAndBoot(tries){
  if(tries>20){document.getElementById("root").innerHTML='<div style="color:#f87171;padding:40px;text-align:center">Failed to load chart libraries. Please refresh the page.</div>';return;}
  if(typeof Recharts==="undefined"){setTimeout(()=>waitAndBoot(tries+1),300);return;}
  bootApp();
}

function bootApp(){
  const {useState,useEffect,useCallback,useRef}=React;
  const {BarChart,Bar,PieChart,Pie,Cell,XAxis,YAxis,CartesianGrid,Tooltip,Legend,ResponsiveContainer}=Recharts;

  const tt={contentStyle:{background:"#0f1923",border:"1px solid #1e293b",borderRadius:8,color:"#e2e8f0"}};

  function el(type,props,...children){return React.createElement(type,props,...children);}

  // â”€â”€ STAT CARD â”€â”€
  function StatCard({label,value,delta,pos,accent,icon}){
    accent=accent||"#38bdf8";
    return el("div",{style:{background:"rgba(15,23,36,0.9)",border:`1px solid ${accent}22`,borderRadius:12,padding:"20px 24px",position:"relative",overflow:"hidden"}},
      el("div",{style:{position:"absolute",top:0,right:0,width:80,height:80,background:`radial-gradient(circle,${accent}15 0%,transparent 70%)`,borderRadius:"50%"}}),
      el("div",{style:{display:"flex",justifyContent:"space-between"}},
        el("div",null,
          el("div",{style:{fontSize:11,color:"#64748b",fontWeight:600,letterSpacing:1,textTransform:"uppercase",marginBottom:8}},label),
          el("div",{style:{fontSize:32,fontWeight:800,color:accent,lineHeight:1,marginBottom:4}},value!=null?value:"â€”"),
          delta&&el("div",{style:{fontSize:12,color:pos?"#4ade80":"#f87171",fontWeight:600}},(pos?"â–²":"â–¼")+" "+delta)
        ),
        el("div",{style:{fontSize:24,opacity:0.4}},icon)
      )
    );
  }

  // â”€â”€ LOGIN â”€â”€
  function LoginPage({onLogin}){
    const [u,setU]=useState(""); const [p,setP]=useState(""); const [err,setErr]=useState("");
    const [loading,setLoading]=useState(false);
    const login=async()=>{
      if(!u||!p){setErr("Please enter username and password.");return;}
      setLoading(true);setErr("");
      try{
        const r=await fetch(BACKEND_URL+"/api/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:u,password:p})});
        const data=await r.json();
        if(!r.ok){setErr(data.error||"Invalid credentials.");return;}
        onLogin(data);
      }catch(e){setErr("Cannot reach server. Please try again.");}
      finally{setLoading(false);}
    };
    return el("div",{style:{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",background:"linear-gradient(135deg,#0a0c10,#0d1117,#0f1923)",position:"relative",overflow:"hidden"}},
      el("div",{style:{position:"absolute",inset:0,backgroundImage:"linear-gradient(rgba(56,189,248,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(56,189,248,0.03) 1px,transparent 1px)",backgroundSize:"40px 40px"}}),
      el("div",{style:{background:"rgba(15,23,36,0.95)",border:"1px solid rgba(56,189,248,0.2)",borderRadius:16,padding:"48px 40px",width:400,boxShadow:"0 0 60px rgba(56,189,248,0.08),0 40px 80px rgba(0,0,0,0.6)",position:"relative",zIndex:1}},
        el("div",{style:{display:"flex",alignItems:"center",gap:10,marginBottom:32}},
          el("div",{style:{width:40,height:40,background:"linear-gradient(135deg,#38bdf8,#0ea5e9)",borderRadius:10,display:"flex",alignItems:"center",justifyContent:"center",fontSize:20}},"ðŸ¢"),
          el("div",null,
            el("div",{style:{fontSize:20,fontWeight:700,color:"#f1f5f9",letterSpacing:-0.5}},"SocietyGuard"),
            el("div",{style:{fontSize:11,color:"#64748b",letterSpacing:2,textTransform:"uppercase"}},"Security Intelligence Platform")
          )
        ),
        el("div",{style:{marginBottom:20}},
          el("label",{style:{fontSize:12,color:"#64748b",fontWeight:600,letterSpacing:1,textTransform:"uppercase",marginBottom:6,display:"block"}},"Username"),
          el("input",{style:{width:"100%",padding:"12px 14px",background:"rgba(30,41,59,0.8)",border:"1px solid rgba(51,65,85,0.8)",borderRadius:8,color:"#e2e8f0",fontSize:14,outline:"none"},value:u,onChange:e=>setU(e.target.value),onKeyDown:e=>e.key==="Enter"&&login(),placeholder:"Enter username"})
        ),
        el("div",{style:{marginBottom:24}},
          el("label",{style:{fontSize:12,color:"#64748b",fontWeight:600,letterSpacing:1,textTransform:"uppercase",marginBottom:6,display:"block"}},"Password"),
          el("input",{style:{width:"100%",padding:"12px 14px",background:"rgba(30,41,59,0.8)",border:"1px solid rgba(51,65,85,0.8)",borderRadius:8,color:"#e2e8f0",fontSize:14,outline:"none"},type:"password",value:p,onChange:e=>setP(e.target.value),onKeyDown:e=>e.key==="Enter"&&login(),placeholder:"Enter password"})
        ),
        el("button",{style:{width:"100%",padding:13,background:"linear-gradient(135deg,#0ea5e9,#38bdf8)",border:"none",borderRadius:8,color:"#0a0c10",fontSize:14,fontWeight:700,cursor:"pointer",marginTop:8,opacity:loading?0.7:1},onClick:login,disabled:loading},loading?"Signing in...":"Sign In â†’"),
        err&&el("div",{style:{color:"#f87171",fontSize:12,marginTop:8,textAlign:"center"}},err),
        el("div",{style:{marginTop:24,padding:12,background:"rgba(30,41,59,0.5)",borderRadius:8,fontSize:11,color:"#475569"}},
          el("div",{style:{fontWeight:700,marginBottom:4,color:"#64748b"}},"LOGIN CREDENTIALS"),
          el("div",null,"superadmin / Super@Guard2026!"),
          el("div",null,"secretary / GreenValley@2026!"),
          el("div",null,"guard1 / Guard@Secure26!")
        )
      )
    );
  }

  // â”€â”€ DASHBOARD â”€â”€
  function Dashboard({user,onLogout}){
    const [client,setClient]=useState(user.client||"C01");
    const [stats,setStats]=useState(null);
    const [events,setEvents]=useState([]);
    const [loading,setLoading]=useState(true);
    const [ok,setOk]=useState(null);
    const [vf,setVf]=useState("today");
    const [vc,setVc]=useState("Bar");
    const [cc,setCc]=useState("Bar");
    const [dc,setDc]=useState("Bar");
    const [log,setLog]=useState([]);
    const [copied,setCopied]=useState(false);
    const timer=useRef(null);
    const cid=user.role==="superuser"?client:user.client;

    const load=useCallback(async()=>{
      try{
        const [s,e]=await Promise.all([apiFetch("/api/stats?client_id="+cid),apiFetch("/api/events?client_id="+cid+"&limit=15")]);
        setStats(s);setEvents(e.events||[]);setOk(true);
        if(e.events&&e.events.length)setLog(e.events.slice(0,10).map(ev=>{
          const t=new Date(ev.timestamp_ist).toLocaleTimeString("en-IN",{hour:"2-digit",minute:"2-digit",second:"2-digit"});
          return "["+t+" IST] "+ev.event_type.toUpperCase()+" @ "+ev.camera_location+(ev.visitor_count?" â€” "+ev.visitor_count+" person(s)":"");
        }));
      }catch(e){setOk(false);}finally{setLoading(false);}
    },[cid]);

    useEffect(()=>{load();timer.current=setInterval(load,15000);return()=>clearInterval(timer.current);},[load]);

    const copy=()=>{navigator.clipboard.writeText(BACKEND_URL+"/webhook");setCopied(true);setTimeout(()=>setCopied(false),2000);};

    const trend=stats?(vf==="today"?stats.trends.hourly.filter(h=>h.hour>=6):stats.trends.weekly):[];
    const cams=stats?stats.camera_activity:[];
    const down=(stats?stats.downtime:[]).map(d=>({...d,"Downtime (hrs)":parseFloat((d.downtime_minutes/60).toFixed(1))}));
    const top=cams&&cams[0];
    const todayV=stats?stats.visitors.today:0;
    const delta=todayV-(stats?stats.visitors.yesterday:0);
    const totalDT=down.reduce((s,c)=>s+c["Downtime (hrs)"],0).toFixed(1);
    const affCams=down.filter(c=>c.incidents>0).length;

    const roleColor=r=>r==="superuser"?"#c084fc":r==="admin"?"#38bdf8":"#4ade80";
    const roleBg=r=>r==="superuser"?"rgba(168,85,247,0.15)":r==="admin"?"rgba(56,189,248,0.15)":"rgba(34,197,94,0.15)";
    const roleBorder=r=>r==="superuser"?"rgba(168,85,247,0.3)":r==="admin"?"rgba(56,189,248,0.3)":"rgba(34,197,94,0.3)";

    const pill=(active,onClick,label)=>el("button",{style:{padding:"6px 14px",borderRadius:20,background:active?"rgba(56,189,248,0.15)":"rgba(30,41,59,0.5)",border:`1px solid ${active?"rgba(56,189,248,0.4)":"rgba(51,65,85,0.5)"}`,color:active?"#38bdf8":"#94a3b8",fontSize:12,fontWeight:600,cursor:"pointer"},onClick},label);
    const tog=(active,onClick,label)=>el("button",{style:{padding:"5px 12px",borderRadius:6,fontSize:11,fontWeight:600,border:"1px solid rgba(56,189,248,0.2)",background:active?"rgba(56,189,248,0.15)":"transparent",color:active?"#38bdf8":"#64748b",cursor:"pointer"},onClick},label);

    return el("div",{style:{minHeight:"100vh",background:"#0a0c10",color:"#e2e8f0"}},
      // NAV
      el("nav",{style:{background:"rgba(10,12,16,0.98)",borderBottom:"1px solid rgba(56,189,248,0.12)",padding:"0 24px",display:"flex",alignItems:"center",justifyContent:"space-between",height:60,position:"sticky",top:0,zIndex:100}},
        el("div",{style:{display:"flex",alignItems:"center",gap:16}},
          el("span",{style:{fontSize:20}},"ðŸ¢"),
          el("span",{style:{fontSize:16,fontWeight:700,color:"#38bdf8"}},"SocietyGuard"),
          el("span",{style:{padding:"3px 10px",borderRadius:20,fontSize:10,fontWeight:700,letterSpacing:1,textTransform:"uppercase",background:roleBg(user.role),color:roleColor(user.role),border:`1px solid ${roleBorder(user.role)}`}},user.role),
          ok!==null&&el("span",{style:{display:"inline-flex",alignItems:"center",gap:6,padding:"4px 10px",borderRadius:20,fontSize:11,fontWeight:600,background:ok?"rgba(74,222,128,0.1)":"rgba(248,113,113,0.1)",color:ok?"#4ade80":"#f87171",border:`1px solid ${ok?"rgba(74,222,128,0.2)":"rgba(248,113,113,0.2)"}`}},
            el("span",{style:{width:6,height:6,borderRadius:"50%",background:ok?"#4ade80":"#f87171",display:"inline-block"}}),
            ok?"Live":"Backend Offline"
          )
        ),
        el("div",{style:{display:"flex",alignItems:"center",gap:16}},
          user.role==="superuser"&&el("div",{style:{display:"flex",alignItems:"center",gap:8}},
            el("span",{style:{fontSize:11,color:"#64748b"}},"CLIENT:"),
            el("select",{style:{padding:"8px 12px",background:"rgba(15,23,36,0.95)",border:"1px solid rgba(56,189,248,0.2)",borderRadius:8,color:"#e2e8f0",fontSize:13,cursor:"pointer",outline:"none"},value:client,onChange:e=>setClient(e.target.value)},
              CLIENTS.map(c=>el("option",{key:c.id,value:c.id},c.name))
            )
          ),
          el("span",{style:{fontSize:13,color:"#94a3b8"}},"ðŸ‘¤ "+user.name),
          el("button",{style:{padding:"7px 16px",background:"transparent",border:"1px solid rgba(248,113,113,0.3)",borderRadius:6,color:"#f87171",fontSize:12,fontWeight:600,cursor:"pointer"},onClick:onLogout},"Sign Out")
        )
      ),

      el("main",{style:{padding:24,maxWidth:1400,margin:"0 auto"}},
        // Header
        el("div",{style:{marginBottom:24}},
          el("div",{style:{fontSize:22,fontWeight:700,color:"#f1f5f9",letterSpacing:-0.5,marginBottom:4}},(CLIENTS.find(c=>c.id===cid)||{name:"Dashboard"}).name),
          el("div",{style:{fontSize:13,color:"#64748b"}},new Date().toLocaleDateString("en-IN",{weekday:"long",year:"numeric",month:"long",day:"numeric"})+" Â· All times in IST")
        ),

        // Webhook Panel â€” superuser only
        user.role==="superuser"&&el("div",{style:{background:"rgba(10,12,16,0.95)",border:"1px solid rgba(56,189,248,0.1)",borderRadius:12,padding:16,marginBottom:24}},
          el("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}},
            el("span",{style:{fontSize:12,color:"#38bdf8",fontWeight:700,letterSpacing:2}},"âš¡ WEBHOOK ENDPOINT"),
            el("span",{style:{fontSize:11,color:"#64748b"}},"Auto-refreshes every 15s")
          ),
          el("div",{style:{background:"rgba(30,41,59,0.5)",border:"1px solid rgba(56,189,248,0.15)",borderRadius:8,padding:"12px 16px",fontFamily:"monospace",fontSize:12,color:"#38bdf8",display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:10}},
            el("span",null,"POST   "+BACKEND_URL+"/webhook"),
            el("button",{style:{padding:"4px 10px",background:"rgba(56,189,248,0.1)",border:"1px solid rgba(56,189,248,0.3)",borderRadius:4,color:"#38bdf8",fontSize:11,cursor:"pointer",fontWeight:600},onClick:copy},copied?"âœ“ Copied":"Copy")
          ),
          el("div",{style:{fontSize:10,color:"#64748b",letterSpacing:1,marginBottom:4}},"LIVE EVENT LOG"),
          el("div",{style:{maxHeight:120,overflowY:"auto",fontFamily:"monospace",fontSize:11}},
            log.length===0
              ?el("span",{style:{color:"#475569"}},"No events yet. Send a POST to the webhook URL above.")
              :log.map((l,i)=>el("div",{key:i,style:{color:i===0?"#4ade80":"#475569",marginBottom:2}},l))
          )
        ),

        loading?el("div",{style:{textAlign:"center",padding:40,color:"#38bdf8"}},"â³ Loading data..."):

        el(React.Fragment,null,
          // Stats
          el("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(200px,1fr))",gap:16,marginBottom:24}},
            el(StatCard,{label:"Today's Visitors",value:todayV,delta:Math.abs(delta)+" vs yesterday",pos:delta>=0,accent:"#38bdf8",icon:"ðŸ‘ï¸"}),
            el(StatCard,{label:"This Week",value:stats?stats.visitors.week:0,accent:"#818cf8",icon:"ðŸ“…"}),
            el(StatCard,{label:"Busiest Camera",value:top?top.camera_id:"â€”",delta:top?top.count+" events Â· "+top.location:"No data",pos:false,accent:"#fb923c",icon:"ðŸ“·"}),
            el(StatCard,{label:"Total Downtime",value:totalDT+"h",delta:affCams+" camera"+(affCams!==1?"s":"")+" affected",pos:false,accent:"#f87171",icon:"âš ï¸"})
          ),

          // Chart Grid
          el("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(420px,1fr))",gap:20,marginBottom:24}},
            // Visitor Trends
            el("div",{style:{background:"rgba(15,23,36,0.9)",border:"1px solid rgba(56,189,248,0.1)",borderRadius:12,padding:"20px 24px"}},
              el("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:20,flexWrap:"wrap",gap:10}},
                el("div",null,
                  el("div",{style:{fontSize:14,fontWeight:700,color:"#e2e8f0"}},"Visitor Trends"),
                  el("div",{style:{fontSize:11,color:"#64748b",marginTop:2}},"IST Â· from webhook data")
                ),
                el("div",{style:{display:"flex",gap:8,flexWrap:"wrap"}},
                  el("div",{style:{display:"flex",gap:8}},
                    pill(vf==="today",()=>setVf("today"),"Today vs Yesterday"),
                    pill(vf==="week",()=>setVf("week"),"Week by Week")
                  ),
                  el("div",{style:{display:"flex",gap:4}},
                    tog(vc==="Bar",()=>setVc("Bar"),"Bar"),
                    tog(vc==="Pie",()=>setVc("Pie"),"Pie")
                  )
                )
              ),
              trend.length===0
                ?el("div",{style:{textAlign:"center",padding:40,color:"#475569",fontSize:12}},"No visitor events yet")
                :el(ResponsiveContainer,{width:"100%",height:220},
                  vc==="Bar"
                    ?el(BarChart,{data:trend,barSize:14},
                        el(CartesianGrid,{strokeDasharray:"3 3",stroke:"rgba(51,65,85,0.4)"}),
                        el(XAxis,{dataKey:"label",tick:{fill:"#64748b",fontSize:10}}),
                        el(YAxis,{tick:{fill:"#64748b",fontSize:10}}),
                        el(Tooltip,tt),
                        el(Legend,null),
                        vf==="week"
                          ?el(Bar,{dataKey:"visitors",fill:"#38bdf8",radius:[4,4,0,0]})
                          :el(React.Fragment,null,
                              el(Bar,{dataKey:"today",name:"Today",fill:"#38bdf8",radius:[4,4,0,0]}),
                              el(Bar,{dataKey:"yesterday",name:"Yesterday",fill:"#818cf8",radius:[4,4,0,0]})
                            )
                      )
                    :el(PieChart,null,
                        el(Pie,{data:trend.filter(d=>(d.today||d.visitors||0)>0),dataKey:vf==="week"?"visitors":"today",nameKey:"label",cx:"50%",cy:"50%",outerRadius:80,label:({name,percent})=>name+" "+(percent*100).toFixed(0)+"%",labelLine:false},
                          trend.map((_,i)=>el(Cell,{key:i,fill:COLORS[i%COLORS.length]}))
                        ),
                        el(Tooltip,tt)
                      )
                )
            ),

            // Camera Activity
            el("div",{style:{background:"rgba(15,23,36,0.9)",border:"1px solid rgba(56,189,248,0.1)",borderRadius:12,padding:"20px 24px"}},
              el("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:20}},
                el("div",null,
                  el("div",{style:{fontSize:14,fontWeight:700,color:"#e2e8f0"}},"Camera Activity"),
                  el("div",{style:{fontSize:11,color:"#64748b",marginTop:2}},"Events this week")
                ),
                el("div",{style:{display:"flex",gap:4}},
                  tog(cc==="Bar",()=>setCc("Bar"),"Bar"),
                  tog(cc==="Pie",()=>setCc("Pie"),"Pie")
                )
              ),
              cams.length===0
                ?el("div",{style:{textAlign:"center",padding:40,color:"#475569",fontSize:12}},"No camera events yet")
                :el(ResponsiveContainer,{width:"100%",height:220},
                  cc==="Bar"
                    ?el(BarChart,{data:cams,layout:"vertical",barSize:14},
                        el(CartesianGrid,{strokeDasharray:"3 3",stroke:"rgba(51,65,85,0.4)",horizontal:false}),
                        el(XAxis,{type:"number",tick:{fill:"#64748b",fontSize:10}}),
                        el(YAxis,{type:"category",dataKey:"camera_id",tick:{fill:"#64748b",fontSize:10},width:60}),
                        el(Tooltip,{...tt,formatter:(v,_,p)=>[v,p.payload.location]}),
                        el(Bar,{dataKey:"count",name:"Events",radius:[0,4,4,0]},
                          cams.map((_,i)=>el(Cell,{key:i,fill:i===0?"#fb923c":COLORS[i%COLORS.length]}))
                        )
                      )
                    :el(PieChart,null,
                        el(Pie,{data:cams,dataKey:"count",nameKey:"camera_id",cx:"50%",cy:"50%",outerRadius:80,label:({name,percent})=>name+" "+(percent*100).toFixed(0)+"%",labelLine:false},
                          cams.map((_,i)=>el(Cell,{key:i,fill:i===0?"#fb923c":COLORS[i%COLORS.length]}))
                        ),
                        el(Tooltip,tt)
                      )
                ),
              top&&el("div",{style:{marginTop:12,padding:"10px 14px",background:"rgba(251,146,60,0.08)",border:"1px solid rgba(251,146,60,0.2)",borderRadius:8,fontSize:12,color:"#fdba74"}},
                "ðŸš¨ ",el("strong",null,top.camera_id+" ("+top.location+")")," â€” highest activity, consider deploying guard"
              )
            )
          ),

          // Downtime
          el("div",{style:{background:"rgba(15,23,36,0.9)",border:"1px solid rgba(56,189,248,0.1)",borderRadius:12,padding:"20px 24px",marginBottom:24}},
            el("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:20}},
              el("div",null,
                el("div",{style:{fontSize:14,fontWeight:700,color:"#e2e8f0"}},"Camera Downtime"),
                el("div",{style:{fontSize:11,color:"#64748b",marginTop:2}},"From camera_offline events Â· UTCâ†’IST")
              ),
              el("div",{style:{display:"flex",gap:4}},
                tog(dc==="Bar",()=>setDc("Bar"),"Bar"),
                tog(dc==="Pie",()=>setDc("Pie"),"Pie")
              )
            ),
            down.length===0
              ?el("div",{style:{textAlign:"center",padding:40,color:"#475569",fontSize:12}},"No camera_offline events yet")
              :el(ResponsiveContainer,{width:"100%",height:200},
                dc==="Bar"
                  ?el(BarChart,{data:down,barSize:20},
                      el(CartesianGrid,{strokeDasharray:"3 3",stroke:"rgba(51,65,85,0.4)"}),
                      el(XAxis,{dataKey:"camera_id",tick:{fill:"#64748b",fontSize:11}}),
                      el(YAxis,{tick:{fill:"#64748b",fontSize:11},unit:"h"}),
                      el(Tooltip,{...tt,formatter:(v,_,p)=>[v+"h ("+p.payload.incidents+" incidents)",p.payload.location||p.payload.camera_id]}),
                      el(Bar,{dataKey:"Downtime (hrs)",radius:[4,4,0,0]},
                        down.map((d,i)=>el(Cell,{key:i,fill:d["Downtime (hrs)"]>1?"#f87171":"#34d399"}))
                      )
                    )
                  :el(PieChart,null,
                      el(Pie,{data:down.filter(d=>d["Downtime (hrs)"]>0),dataKey:"Downtime (hrs)",nameKey:"camera_id",cx:"50%",cy:"50%",outerRadius:80,label:({name,percent})=>name+" "+(percent*100).toFixed(0)+"%",labelLine:false},
                        down.map((_,i)=>el(Cell,{key:i,fill:COLORS[i%COLORS.length]}))
                      ),
                      el(Tooltip,tt)
                    )
              )
          ),

          // Camera Table
          down.length>0&&el("div",{style:{background:"rgba(15,23,36,0.9)",border:"1px solid rgba(56,189,248,0.1)",borderRadius:12,overflow:"hidden",marginBottom:24}},
            el("div",{style:{padding:"16px 24px",display:"flex",justifyContent:"space-between",borderBottom:"1px solid rgba(56,189,248,0.08)"}},
              el("span",{style:{fontSize:14,fontWeight:700,color:"#e2e8f0"}},"Camera Status"),
              el("span",{style:{fontSize:11,color:"#64748b"}},"camera_offline / camera_online events")
            ),
            el("table",{style:{width:"100%",borderCollapse:"collapse",fontSize:13}},
              el("thead",null,el("tr",null,["Camera","Location","Incidents","Downtime","Status"].map(h=>el("th",{key:h,style:{padding:"12px 16px",textAlign:"left",color:"#64748b",fontSize:11,fontWeight:600,letterSpacing:1,textTransform:"uppercase",borderBottom:"1px solid rgba(51,65,85,0.5)"}},h)))),
              el("tbody",null,...down.sort((a,b)=>b["Downtime (hrs)"]-a["Downtime (hrs)"]).map((c,i)=>
                el("tr",{key:i},
                  el("td",{style:{padding:"12px 16px",borderBottom:"1px solid rgba(51,65,85,0.3)",color:"#cbd5e1"}},el("strong",{style:{color:"#e2e8f0"}},c.camera_id)),
                  el("td",{style:{padding:"12px 16px",borderBottom:"1px solid rgba(51,65,85,0.3)",color:"#cbd5e1"}},c.location||c.camera_id),
                  el("td",{style:{padding:"12px 16px",borderBottom:"1px solid rgba(51,65,85,0.3)",color:"#cbd5e1"}},c.incidents),
                  el("td",{style:{padding:"12px 16px",borderBottom:"1px solid rgba(51,65,85,0.3)",color:"#cbd5e1"}},c["Downtime (hrs)"]+"h"),
                  el("td",{style:{padding:"12px 16px",borderBottom:"1px solid rgba(51,65,85,0.3)",fontSize:11,color:c["Downtime (hrs)"]>1?"#fbbf24":"#4ade80"}},c["Downtime (hrs)"]>1?"âš ï¸ Maintenance needed":"âœ… Healthy")
                )
              ))
            )
          ),

          // Events Feed
          (user.role==="admin"||user.role==="superuser")&&events.length>0&&
          el("div",{style:{background:"rgba(15,23,36,0.9)",border:"1px solid rgba(56,189,248,0.1)",borderRadius:12,overflow:"hidden",marginBottom:24}},
            el("div",{style:{padding:"16px 24px",display:"flex",justifyContent:"space-between",borderBottom:"1px solid rgba(56,189,248,0.08)"}},
              el("span",{style:{fontSize:14,fontWeight:700,color:"#e2e8f0"}},"Recent Events"),
              el("span",{style:{fontSize:11,color:"#64748b"}},"Last 15 Â· UTCâ†’IST")
            ),
            el("table",{style:{width:"100%",borderCollapse:"collapse",fontSize:13}},
              el("thead",null,el("tr",null,["IST Time","Camera","Location","Event","Count","Confidence"].map(h=>el("th",{key:h,style:{padding:"12px 16px",textAlign:"left",color:"#64748b",fontSize:11,fontWeight:600,letterSpacing:1,textTransform:"uppercase",borderBottom:"1px solid rgba(51,65,85,0.5)"}},h)))),
              el("tbody",null,...events.map((e,i)=>
                el("tr",{key:i},
                  el("td",{style:{padding:"12px 16px",borderBottom:"1px solid rgba(51,65,85,0.3)",color:"#cbd5e1"}},new Date(e.timestamp_ist).toLocaleString("en-IN",{hour:"2-digit",minute:"2-digit",day:"2-digit",month:"short"})),
                  el("td",{style:{padding:"12px 16px",borderBottom:"1px solid rgba(51,65,85,0.3)",color:"#cbd5e1"}},el("span",{style:{color:"#38bdf8",fontWeight:600}},e.camera_id)),
                  el("td",{style:{padding:"12px 16px",borderBottom:"1px solid rgba(51,65,85,0.3)",color:"#cbd5e1"}},e.camera_location),
                  el("td",{style:{padding:"12px 16px",borderBottom:"1px solid rgba(51,65,85,0.3)",color:"#cbd5e1"}},
                    el("span",{style:{padding:"2px 8px",borderRadius:4,fontSize:11,fontWeight:600,background:e.event_type==="camera_offline"?"rgba(248,113,113,0.15)":e.event_type==="loitering"?"rgba(251,191,36,0.15)":"rgba(56,189,248,0.1)",color:e.event_type==="camera_offline"?"#f87171":e.event_type==="loitering"?"#fbbf24":"#38bdf8"}},e.event_type.replace(/_/g," "))
                  ),
                  el("td",{style:{padding:"12px 16px",borderBottom:"1px solid rgba(51,65,85,0.3)",color:"#cbd5e1"}},e.visitor_count||"â€”"),
                  el("td",{style:{padding:"12px 16px",borderBottom:"1px solid rgba(51,65,85,0.3)",color:"#cbd5e1"}},e.confidence?(e.confidence*100).toFixed(0)+"%":"â€”")
                )
              ))
            )
          )
        )
      )
    );
  }

  function App(){
    const [user,setUser]=useState(null);
    return user?React.createElement(Dashboard,{user,onLogout:()=>setUser(null)}):React.createElement(LoginPage,{onLogin:setUser});
  }

  ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
}

waitAndBoot(0);
</script>
</body>
</html>
